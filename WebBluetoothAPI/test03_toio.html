<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Web Bluetooth API のテスト</title>
</head>

<body>
<button id="connect">接続</button>
<button id="disconnect">切断</button>
<button id="control">操作</button>

<script>
// 情報元： https://qiita.com/tetunori_lego/items/0670587c06fa9e9faf52
//         https://github.com/tetunori/MechanumWheelControlWebBluetooth

const connect = document.getElementById("connect");
const disconnect = document.getElementById("disconnect");
const control = document.getElementById("control");
connect.addEventListener("click", connectCube);
disconnect.addEventListener("click", disconnectCube);
control.addEventListener("click", controlCube);
disconnect.style.backgroundColor = 'lightcoral';

const TOIO_SERVICE_UUID         = '10b20100-5b3b-4571-9508-cf3efcd7bbae'; // https://toio.github.io/toio-spec/docs/ble_communication_overview
//const MOTOR_CHARCTERISTICS_UUID = '10b20102-5b3b-4571-9508-cf3efcd7bbae'; // https://toio.github.io/toio-spec/docs/ble_motor
const LIGHT_CHARCTERISTICS_UUID = '10b20103-5b3b-4571-9508-cf3efcd7bbae';
const cube = {
        device:undefined,
        sever:undefined,
        service:undefined,
//        motorChar:undefined,
        lightChar:undefined
    };

function connectCube() {

  // Scan only toio Core Cubes
  const options = {
      filters: [
          { services: [ TOIO_SERVICE_UUID ] },
          //{namePrefix: "toio"}
      ],
  };

  navigator.bluetooth.requestDevice(options)
  .then(device => {
    cube.device = device;
    console.log("device", device);
    return device.gatt.connect();
  })
  .then(server =>{
    cube.server = server;
    console.log("server", server);
    return server.getPrimaryService(TOIO_SERVICE_UUID);
  })
  .then(service => {
    cube.service = service;
    console.log("service", service);
    return service.getCharacteristic(LIGHT_CHARCTERISTICS_UUID);
  })
  .then(characteristic => {
    cube.lightChar = characteristic;
    console.log("characteristic", characteristic);
    connect.style.backgroundColor = 'skyblue';
    disconnect.style.backgroundColor = 'silver';
  })
  .catch(error => {
    console.log(error);
  });
}

//LEDに表示するメッセージを送信
function controlCube() {
  const buf = new Uint8Array([ 0x03, 0x00, 0x01, 0x01, 0x00, 0xFF, 0x00 ]);
  if( ( cube !== undefined ) && ( cube.lightChar !== undefined ) ){
        cube.lightChar.writeValue( buf );
  }
}

//BLE切断処理
function disconnectCube() {
  if (!cube.device || !cube.device.gatt.connected) return ;
  cube.device.gatt.disconnect();
  disconnect.style.backgroundColor = 'lightcoral';
  connect.style.backgroundColor = 'silver';
  alert("BLE： 切断完了")
}
</script>
</body>
</html>

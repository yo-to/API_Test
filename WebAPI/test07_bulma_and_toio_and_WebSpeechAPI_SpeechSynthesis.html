<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Web Bluetooth API のテスト</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
</head>

<body>

  <section class="section">
    <div class="container">
      <h1 class="title">
        操作用ボタン
      </h1>
      <div class="buttons">
        <button id="connect" class="button is-success is-light">接続</button>
        <button id="disconnect" class="button is-danger is-light">切断</button>
        <button id="control"class="button is-info is-light">操作</button>
      </div>
    </div>
</section>

<script>
// 情報元1： https://qiita.com/tetunori_lego/items/0670587c06fa9e9faf52
//          https://github.com/tetunori/MechanumWheelControlWebBluetooth
// 情報元2： https://app.codegrid.net/entry/2016-web-speech-api-1
// 情報元3： https://qiita.com/belq/items/10ec41f656e47ee2b540

const connect = document.getElementById("connect");
const disconnect = document.getElementById("disconnect");
const control = document.getElementById("control");
connect.addEventListener("click", connectCube);
disconnect.addEventListener("click", disconnectCube);
control.addEventListener("click", controlCube);
disconnect.style.backgroundColor = 'lightcoral';
const text1="接続したよ";
const text2="LEDの色を変えるよ";
const text3="切断したよ";

const TOIO_SERVICE_UUID         = '10b20100-5b3b-4571-9508-cf3efcd7bbae'; // https://toio.github.io/toio-spec/docs/ble_communication_overview
//const MOTOR_CHARCTERISTICS_UUID = '10b20102-5b3b-4571-9508-cf3efcd7bbae'; // https://toio.github.io/toio-spec/docs/ble_motor
const LIGHT_CHARCTERISTICS_UUID = '10b20103-5b3b-4571-9508-cf3efcd7bbae';
const cube = {
        device:undefined,
        sever:undefined,
        service:undefined,
//        motorChar:undefined,
        lightChar:undefined
    };

function connectCube() {

  // Scan only toio Core Cubes
  const options = {
      filters: [
          { services: [ TOIO_SERVICE_UUID ] },
          //{namePrefix: "toio"}
      ],
  };
 
  navigator.bluetooth.requestDevice(options)
  .then(device => {
    cube.device = device;
    console.log("device", device);
    return device.gatt.connect();
  })
  .then(server =>{
    cube.server = server;
    console.log("server", server);
    return server.getPrimaryService(TOIO_SERVICE_UUID);
  })
  .then(service => {
    cube.service = service;
    console.log("service", service);
    return service.getCharacteristic(LIGHT_CHARCTERISTICS_UUID);
  })
  .then(characteristic => {
    cube.lightChar = characteristic;
    console.log("characteristic", characteristic);
    connect.style.backgroundColor = 'skyblue';
    disconnect.style.backgroundColor = 'silver';
    speak(text1);
  })
  .catch(error => {
    console.log(error);
  });
}

function controlCube() {
  const buf = new Uint8Array([ 0x03, 0x00, 0x01, 0x01, 0x00, 0xFF, 0x00 ]);
  if( ( cube !== undefined ) && ( cube.lightChar !== undefined ) ){
        cube.lightChar.writeValue( buf );
        speak(text2);
  }
}

function speak(text){
  var uttr = new SpeechSynthesisUtterance();
  uttr.text = text;
  speechSynthesis.speak(uttr);
};

//BLE切断処理
function disconnectCube() {
  if (!cube.device || !cube.device.gatt.connected) return ;
  cube.device.gatt.disconnect();
  disconnect.style.backgroundColor = 'lightcoral';
  connect.style.backgroundColor = 'silver';
  speak(text3);
  //alert("BLE： 切断完了")
}
</script>
</body>
</html>
